<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>MÃ³dulo de Compras</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet" />
  <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.5/font/bootstrap-icons.css" rel="stylesheet" />
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
  <style>
    .toast-container {
      position: fixed;
      bottom: 1rem;
      right: 1rem;
      z-index: 1055;
    }
  </style>
</head>
<body class="bg-light">

<div class="container py-5">
  <h2 class="mb-4"><i class="bi bi-cart-plus-fill"></i> Registrar Compra</h2>

  <!-- Toasts -->
  <div class="toast-container position-fixed bottom-0 end-0 p-3" id="toastContainer"></div>

  <form id="formCompra" class="card p-4 shadow-sm bg-white mb-4">
    <div class="mb-3">
      <label for="proveedor" class="form-label"><i class="bi bi-person-lines-fill"></i> Seleccionar Proveedor</label>
      <select id="proveedor" class="form-select" required>
        <option value="">Seleccione un proveedor</option>
      </select>
    </div>

    <div id="productosContainer">
      <h5><i class="bi bi-box-seam"></i> Productos</h5>
      <div class="producto mb-3 row gx-2">
        <div class="col-md-4">
          <input type="text" class="form-control nombre" placeholder="Nombre del producto" required>
        </div>
        <div class="col-md-3">
          <input type="number" class="form-control cantidad" placeholder="Cantidad" min="1" required>
        </div>
        <div class="col-md-3">
          <input type="number" class="form-control precio" placeholder="Precio unitario" step="0.01" min="0" required>
        </div>
        <div class="col-md-2">
            <button type="button" class="btn btn-danger w-100 eliminar-producto"><i class="bi bi-trash-fill"></i></button>
        </div>
      </div>
    </div>

    <button type="button" class="btn btn-secondary mb-3" id="agregarProducto"><i class="bi bi-plus-lg"></i> Agregar Producto</button>
    <button type="submit" class="btn btn-primary"><i class="bi bi-check2-circle"></i> Registrar Compra</button>
  </form>

  <button class="btn btn-outline-dark mb-3" id="toggleHistorial"><i class="bi bi-journal-text"></i> Ver historial de compras</button>
  <button class="btn btn-success mt-1" id="generarPDF"><i class="bi bi-file-earmark-pdf"></i> Generar Reporte PDF</button>

  <div id="historialContainer" class="d-none">
    <input type="text" id="filtroProveedor" class="form-control mb-3" placeholder="ðŸ” Buscar por proveedor...">
    <h3 class="mb-3"><i class="bi bi-clock-history"></i> Historial de Compras</h3>
    <div class="table-responsive">
      <table class="table table-bordered table-hover bg-white shadow-sm" id="tablaCompras">
        <thead class="table-dark">
          <tr>
            <th>Proveedor</th>
            <th>Fecha</th>
            <th>Productos</th>
            <th>Total</th>
          </tr>
        </thead>
        <tbody></tbody>
      </table>
    </div>
  </div>
</div>

<script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/10.11.0/firebase-app.js";
  import { getFirestore, collection, getDocs, addDoc, doc, getDoc, query, orderBy } from "https://www.gstatic.com/firebasejs/10.11.0/firebase-firestore.js";

  const firebaseConfig = {
    apiKey: "AIzaSyCaEoCUyBH2vF10R7IYfatFzA54W7gt6yw",
    authDomain: "erparquitectura-5d0fa.firebaseapp.com",
    projectId: "erparquitectura-5d0fa",
    storageBucket: "erparquitectura-5d0fa.appspot.com",
    messagingSenderId: "609943109713",
    appId: "1:609943109713:web:f49061250c06bf4aa5f870",
    measurementId: "G-5QS2K0K2X2"
  };

  const app = initializeApp(firebaseConfig);
  const db = getFirestore(app);

  const currencyFormat = new Intl.NumberFormat("es-CO", {
    style: "currency",
    currency: "COP"
  });

  function mostrarToast(mensaje, tipo = 'info') {
    const container = document.getElementById('toastContainer');
    const toast = document.createElement('div');
    toast.className = `toast align-items-center text-bg-${tipo} border-0 show mb-2`;
    toast.setAttribute('role', 'alert');
    toast.setAttribute('aria-live', 'assertive');
    toast.setAttribute('aria-atomic', 'true');
    toast.innerHTML = `
      <div class="d-flex">
        <div class="toast-body">${mensaje}</div>
        <button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast"></button>
      </div>
    `;
    container.appendChild(toast);
    setTimeout(() => toast.remove(), 5000);
  }

  async function cargarProveedores() {
    const proveedorSelect = document.getElementById("proveedor");
    const snapshot = await getDocs(collection(db, "proveedores"));
    proveedorSelect.innerHTML = '<option value="">Seleccione un proveedor</option>';
    snapshot.forEach((doc) => {
      const data = doc.data();
      const option = document.createElement("option");
      option.value = doc.id;
      option.textContent = `${data.nombre} - ${data.empresa}`;
      proveedorSelect.appendChild(option);
    });
  }

  document.getElementById("agregarProducto").addEventListener("click", () => {
    document.getElementById("productosContainer").insertAdjacentHTML('beforeend', `
      <div class="producto mb-3 row gx-2">
        <div class="col-md-4">
          <input type="text" class="form-control nombre" placeholder="Nombre del producto" required>
        </div>
        <div class="col-md-3">
          <input type="number" class="form-control cantidad" placeholder="Cantidad" min="1" required>
        </div>
        <div class="col-md-3">
          <input type="number" class="form-control precio" placeholder="Precio" step="0.01" min="0" required>
        </div>
        <div class="col-md-2">
          <button type="button" class="btn btn-danger w-100 eliminar-producto"><i class="bi bi-trash-fill"></i></button>
        </div>
      </div>
    `);
  });

  document.getElementById("productosContainer").addEventListener("click", (e) => {
    if (e.target.closest(".eliminar-producto")) {
      e.target.closest(".producto").remove();
    }
  });

  document.getElementById("formCompra").addEventListener("submit", async (e) => {
    e.preventDefault();
    const proveedorId = document.getElementById("proveedor").value;
    if (!proveedorId) return mostrarToast("Seleccione un proveedor", "warning");

    const productos = [];
    let total = 0;

    document.querySelectorAll(".producto").forEach((div) => {
      const nombre = div.querySelector(".nombre").value;
      const cantidad = parseInt(div.querySelector(".cantidad").value);
      const precio = parseFloat(div.querySelector(".precio").value);
      if (nombre && cantidad > 0 && precio >= 0) {
        productos.push({ nombre, cantidad, precio });
        total += cantidad * precio;
      }
    });

    if (productos.length === 0) return mostrarToast("Agregue al menos un producto vÃ¡lido", "danger");

    try {
      await addDoc(collection(db, "compras"), {
        proveedorId,
        productos,
        total,
        fecha: new Date()
      });
      mostrarToast("Compra registrada exitosamente âœ…", "success");
      e.target.reset();
      document.getElementById("productosContainer").innerHTML = "";
      document.getElementById("agregarProducto").click();
      cargarCompras();
    } catch (error) {
      console.error("Error al registrar compra:", error);
      mostrarToast("Error al guardar la compra âŒ", "danger");
    }
  });

  async function cargarCompras() {
    const tbody = document.querySelector("#tablaCompras tbody");
    tbody.innerHTML = "";
    const comprasSnapshot = await getDocs(query(collection(db, "compras"), orderBy("fecha", "desc")));

    for (const docCompra of comprasSnapshot.docs) {
      const data = docCompra.data();
      const proveedorRef = await getDoc(doc(db, "proveedores", data.proveedorId));
      const proveedorNombre = proveedorRef.exists() ? proveedorRef.data().nombre : "Desconocido";
      const fecha = new Date(data.fecha.seconds * 1000).toLocaleString();

      const productosHTML = data.productos.map(prod =>
        `<li>${prod.nombre} (x${prod.cantidad}) - ${currencyFormat.format(prod.precio)}</li>`
      ).join("");

      const filaHTML = `
        <tr data-proveedor="${proveedorNombre.toLowerCase()}">
          <td>${proveedorNombre}</td>
          <td>${fecha}</td>
          <td><ul>${productosHTML}</ul></td>
          <td>${currencyFormat.format(data.total || 0)}</td>
        </tr>`;
      
      tbody.insertAdjacentHTML("beforeend", filaHTML);
    }
  }

  document.getElementById("filtroProveedor").addEventListener("input", () => {
    const filtro = document.getElementById("filtroProveedor").value.toLowerCase();
    const filas = document.querySelectorAll("#tablaCompras tbody tr");
    filas.forEach(fila => {
      const proveedor = fila.getAttribute("data-proveedor");
      fila.style.display = proveedor.includes(filtro) ? "" : "none";
    });
  });

  document.getElementById("toggleHistorial").addEventListener("click", () => {
    const contenedor = document.getElementById("historialContainer");
    contenedor.classList.toggle("d-none");
    const btn = document.getElementById("toggleHistorial");
    btn.innerHTML = contenedor.classList.contains("d-none")
      ? '<i class="bi bi-journal-text"></i> Ver historial de compras'
      : '<i class="bi bi-x-circle-fill"></i> Ocultar historial';
  });

  // Generar PDF
  document.getElementById("generarPDF").addEventListener("click", () => {
    const historial = document.getElementById("historialContainer");
    if (historial.classList.contains("d-none")) {
      mostrarToast("Primero muestra el historial de compras", "warning");
      return;
    }

    html2canvas(historial).then(canvas => {
      const imgData = canvas.toDataURL("image/png");
      const pdf = new jspdf.jsPDF("p", "mm", "a4");
      const imgProps = pdf.getImageProperties(imgData);
      const pdfWidth = pdf.internal.pageSize.getWidth();
      const pdfHeight = (imgProps.height * pdfWidth) / imgProps.width;
      pdf.addImage(imgData, "PNG", 0, 0, pdfWidth, pdfHeight);
      pdf.save("reporte_compras.pdf");
    });
  });


  cargarProveedores();
  cargarCompras();
</script>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
</body>
</html>
